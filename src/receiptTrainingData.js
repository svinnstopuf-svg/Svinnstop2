// Verkliga kvittodata för att träna AI:n att förstå kvittostrukturer
export const digitalReceiptExamples = [
  {
    store: "ICA Maxi",
    date: "2024-01-15",
    products: [
      "BANANER KLASS 1",
      "GURKA MINI 500G",
      "*AVOKADO READY TO EAT",
      "TOMAT KVIST 500G",
      "LAKRITSMIX 200G",
      "CHAMPINJONER 250G",
      "MJÖLK ARLA KO 3% 1L",
      "SMÖR BREGOTT 500G",
      "BRÖD POLAR LIMPA",
      "ÄPPLEN ROYAL GALA 1KG",
      "POTATIS FAST 2KG",
      "LÖKGUL 1KG NET",
      "MORÖTTER 1KG",
      "KÖTT FLÄSKFILÉ 400G",
      "KYCKLING HELFIL 500G",
      "OST HERRGÅRD 17% 500G",
      "PASTA BARILLA PENNE 500G",
      "RIS JASMIN 1KG",
      "OLJA ZETA OLIVOLJA 500ML"
    ]
  },
  {
    store: "Coop",
    date: "2024-02-03", 
    products: [
      "Banan Eko",
      "Paprika Röd 3-pack",
      "Sallad Iceberg",
      "Yoghurt Arla Naturell 1kg",
      "Grädde Vispgrädde 5dl",
      "Kött Nötfärs 500g",
      "Fisk Lax Färsk 300g",
      "Ägg Frigående 12-pack",
      "Juice Bravo Apelsin 1L",
      "Kaffe Gevalia Mellanrost",
      "Socker Dansukker 1kg",
      "Mjöl Kungsörnen Vetemjöl 2kg",
      "Tomat Krossad Felix 400g",
      "Pasta Garofalo Spagetti",
      "Olivolja Zeta Extra Virgin"
    ]
  },
  {
    store: "Willys",
    date: "2024-02-20",
    products: [
      "BANAN EKO 1KG",
      "CITRON 500G NET",
      "KIWI 6-PACK",
      "FILMJÖLK ARLA 3% 1L",
      "KVARG NATURELL 500G",
      "KORV FALUKORV SCAN 800G",
      "RÄKOR NORDSJÖ 300G",
      "BRÖD SKOGAHOLM LIMPA",
      "MÜSLI KELLOGGS 500G",
      "HONUNG SVENSK 500G",
      "GURKA MINI",
      "PAPRIKA GUL",
      "CHAMPINJON SKIVAD 250G",
      "LAXFILÉ FÄRSK 400G",
      "YOGHURT GREKISK 200G"
    ]
  },
  {
    store: "Hemköp", 
    date: "2024-03-01",
    products: [
      "Äpplen Granny Smith 1kg",
      "Blåbär Frysta 500g",
      "Spenat Baby 125g",
      "Rucola Färsk 80g",
      "Mjölk Laktosfri 3% 1L",
      "Ost Västerbotten 300g",
      "Smörgåsmargarin Flora 400g",
      "Kött Köttfärs Blandfärs 500g",
      "Kyckling Kycklingfilé 600g",
      "Fisk Torskfilé 400g",
      "Nudlar Ramen 5-pack",
      "Ris Basmati Uncle Bens 1kg",
      "Sås Sojasås Kikkoman",
      "Krydda Salladskrydda Santa Maria"
    ]
  },
  {
    store: "Lidl",
    date: "2024-03-15", 
    products: [
      "Bio Bananer 1kg",
      "Avocado Ready to Eat 2st",
      "Lime 4-pack",
      "Paprika Mix 500g",
      "Mjölkdryck Haver 1L",
      "Crème Fraiche 34% 2dl",
      "Köttbullar Frysta 1kg",
      "Kassler Rökt 300g",
      "Tunnbröd Polarbröd 4-pack",
      "Havregryn Stora 1.5kg",
      "Marmelad Jordgubb 450g",
      "Tomat Passerade 500g",
      "Bulgur 500g",
      "Linser Röda 500g"
    ]
  },
  {
    store: "ICA Supermarket",
    date: "2024-04-01",
    products: [
      "*BANAN KLASS1",
      "*GURKA MINI",
      "*AVOKADO READY",
      "*TOMAT KVIST",
      "*SVAMP CHAMPINJON",
      "*LAKRITSMIX HARIBO",
      "POTATIS FAST 2KG",
      "MOROT 1KG NET",
      "LÖK GUL 1KG",
      "SALLAD ISEBERG",
      "PAPRIKA RÖD 3ST",
      "CITRON 500G NET",
      "ÄPPLE GRANNY 1KG",
      "KÖTT NÖTFÄRS 500G",
      "FISK LAX FILÉ 400G"
    ]
  },
  {
    store: "Coop Konsum", 
    date: "2024-04-12",
    products: [
      "Banan, Gurka, Avokado",
      "Tomat kvist, Paprika röd",
      "Svamp champinjon 250g",
      "Lakritsmix Malaco 200g",
      "Potatis Almond 2kg",
      "Morötter svenska 1kg",
      "Lök gul lösvikt",
      "Sallad Iceberg färsk",
      "Citron klass 1",
      "Äpplen Royal Gala",
      "Kött köttfärs nöt 500g",
      "Lax färsk Norge 300g"
    ]
  },
  {
    store: "Maxi ICA Stormarknad",
    date: "2024-04-20",
    products: [
      "1. BANAN EKO",
      "2. GURKA MINI 500G", 
      "3. AVOKADO 2ST",
      "4. TOMAT KÖRSBÄR 250G",
      "5. CHAMPINJON SKIVAD",
      "6. LAKRITS DJUNGELVRÅL",
      "7. POTATIS MANDEL 2KG",
      "8. MOROT EKOLOGISK 1KG",
      "9. RÖDLÖK 500G NET",
      "10. SALLAD MIX 125G",
      "11. PAPRIKA GUL",
      "12. LIME 4-PACK"
    ]
  },
  {
    store: "Willys Hemma Bäst",
    date: "2024-05-01", 
    products: [
      "BANANA ORGANIC 1KG............12.90",
      "CUCUMBER MINI 500G..............8.95",
      "AVOCADO READY 2PCS.............19.90",
      "TOMATO CHERRY 250G.............14.50",
      "MUSHROOM SLICED 250G...........12.00",
      "LICORICE MIX 200G..............22.90",
      "POTATO NEW 1.5KG...............16.90",
      "CARROT ORGANIC 1KG.............11.90",
      "ONION YELLOW 1KG NET...........8.90",
      "SALAD ICEBERG..................9.90"
    ]
  },
  {
    store: "Hemköp Express",
    date: "2024-05-15",
    products: [
      "① Bananer Klass I",
      "② Gurka Mini-gurka",
      "③ Avokado Ready to eat", 
      "④ Tomater kvist svenska",
      "⑤ Svamp champinjon vita",
      "⑥ Lakritsmix lösvikt",
      "⑦ Potatis fast kokning",
      "⑧ Morötter svenska ekologiska",
      "⑨ Lök gul lösvikt netto",
      "⑩ Sallad iseberg hel",
      "⑪ Paprika röd 3-pack",
      "⑫ Citroner klass I netto"
    ]
  },
  {
    store: "Lidl Sverige",
    date: "2024-05-30",
    products: [
      "→ BIO BANANER 1KG",
      "→ MINI GURKOR 400G",
      "→ AVOKADO 2ST MOGNA",
      "→ KÖRSBÄRSTOMAT 250G", 
      "→ CHAMPINJONER 300G",
      "→ LAKRITS SALTLAKRITS",
      "→ POTATIS FAST 2KG",
      "→ EKOLOGISK MOROT 1KG",
      "→ GUL LÖK 1KG NETTO",
      "→ ISBERGSSALLAD 1ST",
      "→ RÖD PAPRIKA 500G",
      "→ CITRON 4ST NETTO"
    ]
  },
  {
    store: "COOP EXTRA",
    date: "2024-06-10",
    products: [
      "▪ Banan Fynd 1kg",
      "▪ Gurka mini 6-pack", 
      "▪ Avokado klass I 3st",
      "▪ Tomat på kvist 500g",
      "▪ Svamp portabello 200g",
      "▪ Lakritsbåtar Malaco",
      "▪ Lakritsmix Haribo",
      "▪ Potatis Amandine 1.5kg",
      "▪ Morötter baby 400g",
      "▪ Schalottenlök 250g",
      "▪ Babyspenat 80g",
      "▪ Paprika mix 3-färg",
      "▪ Lime färsk 6st"
    ]
  },
  {
    store: "ICA Kvantum", 
    date: "2024-06-25",
    products: [
      "• BANANER FAIRTRADE",
      "• GURKA VÄXTHUS",
      "• AVOKADO HASS",
      "• TOMAT PLOMMON",
      "• OSTRONSVAMP",
      "• SALTLAKRITS",
      "• FÄRSKPOTATIS",
      "• PRIMÖRMORÖTTER",
      "• PÄRLLÖK",
      "• RUCCOLA",
      "• SPETSPAPRIKA",
      "• BERGAMOTT"
    ]
  },
  {
    store: "City Gross",
    date: "2024-07-01",
    products: [
      "◆ Bananer Chiquita 1kg 12,90",
      "◆ Mini-gurka 500g paket 8,50",
      "◆ Avokado mogna 2st 15,80",
      "◆ Cocktailtomat 250g 11,90", 
      "◆ Champinjon hel 400g 9,90",
      "◆ Lakritshjul Haribo 13,90",
      "◆ Potatis Solist 2kg 22,90",
      "◆ Morot bunt svensk 7,90",
      "◆ Vitlök klass I 4,90",
      "◆ Frisésallad 1st 12,90",
      "◆ Romano paprika 14,90",
      "◆ Grapefrukt rosa 8,90"
    ]
  },
  {
    store: "TEMPO",
    date: "2024-07-15",
    products: [
      "≫ BANAN KLASS 1 1KG",
      "≫ GURKA MINI VÄXTHUS", 
      "≫ AVOKADO READY 3ST",
      "≫ TOMAT KÖTT SVENSK",
      "≫ SVAMP KANTARELL",
      "≫ LAKRITS AHLGRENS",
      "≫ POTATIS NY SVENSK",
      "≫ MOROT STOR KLASS1",
      "≫ LÖK RÖD MILD",
      "≫ SALLAD LOLLO ROSSO",
      "≫ PAPRIKA GRÖN",
      "≫ APELSIN NAVEL"
    ]
  },
  {
    store: "WILLYS",
    date: "2024-08-01",
    products: [
      "*Banan Ecuador Fair Trade",
      "*Gurka Hollandsk",
      "*Mini gurkor 400g", 
      "*Avokado Ready To Eat 2st",
      "*Hass Avokado 3st",
      "*Svamp Champinjoner 250g",
      "*Svamp Portabello",
      "*Lakritsmix ICA Basic",
      "*Saltlakrits Djungelvrål",
      "*Lakritsbåtar Mixed",
      "*Tomat Cherry 250g",
      "*Tomat Kött 500g"
    ]
  }
];

// Extrahera alla unika produktnamn för träning
export const trainingProductNames = digitalReceiptExamples
  .flatMap(receipt => receipt.products)
  .map(product => product.toLowerCase().trim());

// Vanliga kvittoformat och mönster
export const receiptPatterns = {
  // Kvantitetsformat som ofta förekommer
  quantities: [
    /\d+\s*kg/gi,         // "1 kg", "2kg"
    /\d+\s*g/gi,          // "500 g", "250g"
    /\d+\s*ml/gi,         // "500 ml", "1000ml"
    /\d+\s*l/gi,          // "1 l", "2L"
    /\d+\s*st/gi,         // "2 st", "12st"
    /\d+\s*pack/gi,       // "3-pack", "6 pack"
    /\d+\s*dl/gi,         // "5 dl", "3dl"
    /\d+\%/gi             // "3%", "17%"
  ],
  
  // Vanliga prefix som kan ignoreras/tas bort
  prefixes: [
    /^[\*\-\+\>\<\#\@\&→▪•◆≫①-⑩⑪⑫]/,  // Alla symboler inkl. Unicode
    /^\d+\.\s*/,             // "1. ", "2. ", etc.
    /^eko\s+/gi,             // "EKO "
    /^bio\s+/gi,             // "BIO "
    /^krav\s+/gi,            // "KRAV "
    /^ekologisk\s+/gi,       // "EKOLOGISK "
    /^färsk\s+/gi,            // "FÄRSK "
    /^svenska?\s+/gi,        // "SVENSK ", "SVENSKA "
    /^\d+\s+/,               // Nummer i början
    /^→\s*/,               // Pil-symbol "→ "
    /^▪\s*/,               // Fyrkantig punkt "▪ "
    /^•\s*/,               // Bullet point "• "
    /^◆\s*/,               // Diamant "◆ "
    /^≫\s*/,               // Dubbel vinkel "≫ "
    /^①-⑫\s*/,          // Numrerade cirklar "①-⑫ "
    /^\([\d\w]\)\s*/,        // Parenteser "(1) "
    /^\.+\s*/,               // Punkter i början
    /^[A-Z]\d+\.\s*/         // "A1. ", "B2. " etc.
  ],
  
  // Vanliga suffix som kan ignoreras
  suffixes: [
    /\s+klass\s+\d+$/gi,     // " KLASS 1"
    /\s+net$/gi,             // " NET"
    /\s+färsk$/gi,           // " FÄRSK"
    /\s+frysta?$/gi,         // " FRYSTA"
    /\s+eko$/gi              // " EKO"
  ],
  
  // Vanliga varumärken som förekommer på kvitton
  brands: [
    'arla', 'scan', 'felix', 'barilla', 'gevalia', 'kelloggs', 
    'bregott', 'flora', 'polar', 'skogaholm', 'zeta', 'garofalo',
    'bravo', 'kungsörnen', 'dansukker', 'kikkoman', 'uncle bens',
    'santa maria', 'nordsjö', 'marabou', 'fazer'
  ]
};

// Intelligenta rensningsregler baserat på kvittoanalys
export function cleanReceiptProductName(rawName) {
  let cleaned = rawName.toLowerCase().trim();
  
  // Ta bort priser med prickar: "BANANA ORGANIC 1KG............12.90"
  cleaned = cleaned.replace(/\.{3,}\d+[.,]\d{2}.*$/, '');
  
  // Ta bort kommaseparerade listor - dela upp dem istället
  if (cleaned.includes(',') && cleaned.split(',').length <= 4) {
    // Hantera som kommaseparerad lista senare
    return cleaned;
  }
  
  // Ta bort vanliga prefix
  receiptPatterns.prefixes.forEach(pattern => {
    cleaned = cleaned.replace(pattern, '');
  });
  
  // Ta bort vanliga suffix
  receiptPatterns.suffixes.forEach(pattern => {
    cleaned = cleaned.replace(pattern, '');
  });
  
  // Ta bort kvantiteter (men behåll produktnamnet)
  receiptPatterns.quantities.forEach(pattern => {
    cleaned = cleaned.replace(pattern, '');
  });
  
  // Ta bort priser i slutet: "produktnamn 12,90" eller "produktnamn 12.90"
  cleaned = cleaned.replace(/\s+\d+[.,]\d{2}\s*kr?\s*$/gi, '');
  
  // Ta bort extra beskrivningar
  cleaned = cleaned.replace(/\s+(klass|class)\s+[iv1-9]+$/gi, '');
  cleaned = cleaned.replace(/\s+ready\s+to\s+eat$/gi, '');
  cleaned = cleaned.replace(/\s+netto?$/gi, '');
  cleaned = cleaned.replace(/\s+lösvikt$/gi, '');
  cleaned = cleaned.replace(/\s+(häl|hel|hela?)$/gi, '');
  
  // Normalisera mellanslag
  cleaned = cleaned.replace(/\s+/g, ' ').trim();
  
  return cleaned;
}

// Analysera om ett produktnamn liknar de i träningsdatan
export function analyzeAgainstTrainingData(productName) {
  const cleanedName = cleanReceiptProductName(productName);
  
  // Special hantering för kommaseparerade listor: "Banan, Gurka, Avokado"
  if (cleanedName.includes(',')) {
    const items = cleanedName.split(',').map(item => item.trim()).filter(item => item.length > 2);
    if (items.length > 1) {
      // Analysera varje del separat och returnera högsta konfidens
      let bestConfidence = 0;
      let bestMatches = [];
      
      for (const item of items) {
        const itemAnalysis = analyzeAgainstTrainingData(item); // Rekursiv analys
        if (itemAnalysis.confidence > bestConfidence) {
          bestConfidence = itemAnalysis.confidence;
          bestMatches = itemAnalysis.matches;
        }
      }
      
      return {
        confidence: Math.min(bestConfidence + 0.1, 1.0), // Liten bonus för kommalista
        matches: bestMatches,
        cleanedName,
        reason: 'comma_separated_list'
      };
    }
  }
  
  const words = cleanedName.split(/\s+/);
  let confidence = 0;
  let matches = [];
  
  // Kolla mot träningsdata
  for (const trainingProduct of trainingProductNames) {
    const trainingCleaned = cleanReceiptProductName(trainingProduct);
    const trainingWords = trainingCleaned.split(/\s+/);
    
    // Direktmatch
    if (cleanedName === trainingCleaned) {
      return { confidence: 1.0, matches: [trainingProduct], reason: 'exact_match' };
    }
    
    // Partiell ordmatch
    const matchingWords = words.filter(word => 
      word.length > 2 && trainingWords.some(tw => 
        tw.includes(word) || word.includes(tw)
      )
    );
    
    if (matchingWords.length > 0) {
      const wordConfidence = matchingWords.length / Math.max(words.length, trainingWords.length);
      if (wordConfidence > confidence) {
        confidence = wordConfidence;
        matches = [trainingProduct];
      }
    }
    
    // Extra kontroll för fuzzy matching av hela strängen
    const similarity = calculateSimilarity(cleanedName, trainingCleaned);
    if (similarity > 0.7 && similarity > confidence) {
      confidence = similarity;
      matches = [trainingProduct];
    }
  }
  
  // Kolla mot kända varumärken
  const brandMatch = receiptPatterns.brands.find(brand => 
    cleanedName.includes(brand)
  );
  
  if (brandMatch) {
    confidence = Math.max(confidence, 0.7);
    matches.push(`brand:${brandMatch}`);
  }
  
  return {
    confidence,
    matches,
    cleanedName,
    reason: confidence > 0.5 ? 'training_match' : confidence > 0.3 ? 'weak_match' : 'no_match'
  };
}

// Hjälpfunktion för att beräkna stränglikhet
function calculateSimilarity(str1, str2) {
  const len1 = str1.length;
  const len2 = str2.length;
  const maxLen = Math.max(len1, len2);
  
  if (maxLen === 0) return 1.0;
  
  // Enkel Levenshtein-baserad likhet
  const distance = levenshteinDistance(str1, str2);
  return 1 - (distance / maxLen);
}

function levenshteinDistance(str1, str2) {
  const matrix = [];
  
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }
  
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  return matrix[str2.length][str1.length];
}
